services:
  api:
    image: 'ghcr.io/firecrawl/firecrawl:latest'
    environment:
      - PORT=3002
      - HOST=0.0.0.0
      - 'REDIS_URL=redis://redis:6379'
      - 'REDIS_RATE_LIMIT_URL=redis://redis:6379'
      - USE_DB_AUTHENTICATION=false
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
      - POSTGRES_HOST=nuq-postgres
      - POSTGRES_PORT=5432
      - 'NUQ_DATABASE_URL=postgres://postgres:postgres@nuq-postgres:5432/postgres'
      - NUM_WORKERS_PER_QUEUE=8
      - 'OPENAI_API_KEY=${OPENAI_API_KEY}'
      - 'OPENAI_BASE_URL=${OPENAI_BASE_URL}'
      - 'MODEL_NAME=${MODEL_NAME:-gpt-5-mini}'
      - BULL_AUTH_KEY=firecrawl-admin
      - 'NUQ_RABBITMQ_URL=amqp://rabbitmq:5672'
    depends_on:
      nuq-postgres:
        condition: service_healthy
      redis:
        condition: service_started
    ports:
      - '3002:3002'
    networks:
      - backend
    restart: unless-stopped

  worker:
    image: 'ghcr.io/firecrawl/firecrawl:latest'
    environment:
      - PORT=3002
      - HOST=0.0.0.0
      - 'REDIS_URL=redis://redis:6379'
      - 'REDIS_RATE_LIMIT_URL=redis://redis:6379'
      - USE_DB_AUTHENTICATION=false
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
      - POSTGRES_HOST=nuq-postgres
      - POSTGRES_PORT=5432
      - 'NUQ_DATABASE_URL=postgres://postgres:postgres@nuq-postgres:5432/postgres'
      - NUM_WORKERS_PER_QUEUE=8
      - 'OPENAI_API_KEY=${OPENAI_API_KEY}'
      - 'OPENAI_BASE_URL=${OPENAI_BASE_URL}'
      - 'MODEL_NAME=${MODEL_NAME:-gpt-5-mini}'
      - 'NUQ_RABBITMQ_URL=amqp://rabbitmq:5672'
    command: ["node", "--max-old-space-size=8192", "dist/src/services/queue-worker.js"]
    depends_on:
      nuq-postgres:
        condition: service_healthy
      redis:
        condition: service_started
    networks:
      - backend
    restart: unless-stopped

  redis:
    image: 'redis:alpine'
    networks:
      - backend
    command: 'redis-server --bind 0.0.0.0'
    restart: unless-stopped

  rabbitmq:
    image: 'rabbitmq:3-alpine'
    networks:
      - backend
    restart: unless-stopped

  nuq-postgres:
    image: 'postgres:16-alpine'
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    volumes:
      - 'postgres-data:/var/lib/postgresql/data'
      - './init-nuq.sql:/docker-entrypoint-initdb.d/01-init-nuq.sql:ro'
    networks:
      - backend
    healthcheck:
      test:
        - CMD-SHELL
        - 'pg_isready -U postgres -d postgres'
      interval: 5s
      timeout: 5s
      retries: 10
    restart: unless-stopped

networks:
  backend:

volumes:
  postgres-data:
